services:
  certbot-renew:
    image: certbot/dns-cloudflare:latest
    container_name: certbot-renew
    volumes:
      - ./certbot/conf:/etc/letsencrypt
    environment:
      - CF_API_TOKEN=${CF_TOKEN}
    networks:
      - app-network
    command: >
      renew --dns-cloudflare

  fastapi:
    image: registry.cn-chengdu.aliyuncs.com/jusu/pymecli:latest
    container_name: fastapi
    ports:
      - "8877:8000"
    expose:
      - "8000"
    volumes:
      - ./certbot/conf:/etc/letsencrypt
    environment:
      - PROXY=socks5://192.168.123.7:7890
    command: >
      fast 0.0.0.0 --port 8000
      --rule https://cdn.jsdelivr.net/gh/Loyalsoldier/clash-rules@release
      --my-rule https://raw.githubusercontent.com/meme2046/data/refs/heads/main/clash
      --proxy socks5://192.168.123.7:7890
    depends_on:
      - certbot-renew
    networks:
      - app-network
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "8888:80"
      - "443:443"
    volumes:
      - ./files/.nginx:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt
    depends_on:
      - fastapi
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge
